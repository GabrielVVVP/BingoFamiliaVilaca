<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo da Família Vilaça</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #fdf2f2; /* Tom de fundo quente e acolhedor */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-card {
            background: linear-gradient(135deg, #ffffff 0%, #f3f4f6 100%);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        }
        .number-display {
            text-shadow: 2px 2px 0px rgba(255, 255, 255, 0.5);
            font-variant-numeric: tabular-nums;
        }
        .history-item {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom Switch para a IA */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px; width: 26px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body class="text-gray-800 min-h-screen flex flex-col items-center">

    <!-- CABEÇALHO E FOTO DA FAMÍLIA -->
    <header class="w-full max-w-5xl px-6 pt-10 pb-6 text-center">
        <h1 class="text-5xl md:text-6xl font-black text-red-600 drop-shadow-sm mb-4">
            Bingo da Família Vilaça
        </h1>
        
        <!-- Espaço para a Foto da Família (altura ajustada para comportar a imagem) -->
        <div class="flex justify-center mb-6 w-full">
            <div class="max-w-4xl relative overflow-hidden shadow-xl border-4 border-white bg-gray-200 mx-auto">
                <!-- IMPORTANTE: Substitua 'familia.jpg' pelo nome do seu arquivo de imagem na mesma pasta -->
                <img src="familia.jpg" alt="Foto da Família Vilaça" class="w-full h-auto object-contain object-center block" onerror="this.src='https://via.placeholder.com/1200x600?text=Família+Vilaça'">
            </div>
        </div>
        <p class="text-xl text-gray-600 italic">"Todo mundo aqui ama esse bingo!"</p>
    </header>

    <!-- ÁREA PRINCIPAL -->
    <main class="w-full max-w-4xl px-4 flex flex-col items-center">
        
        <!-- Painel de Exibição -->
        <div id="display-panel" class="main-card w-full rounded-[3rem] p-10 border-4 border-red-500 flex flex-col items-center justify-center relative">
            <div id="current-call" class="text-center">
                <span id="label-letter" class="text-4xl md:text-6xl font-bold text-red-600 block leading-none">VAMOS</span>
                <span id="label-number" class="text-[4rem] md:text-[6rem] font-black text-gray-900 leading-none number-display">JOGAR!</span>
            </div>

            <!-- (Removido overlay de loading da IA) -->
        </div>

        <!-- CONFIGURAÇÕES E CONTROLES -->
        <div class="w-full mt-8 grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
            
            <!-- Botões Principais -->
            <div class="flex flex-col gap-4">
                <button id="btn-draw" class="bg-red-600 hover:bg-red-700 text-white text-4xl font-bold py-6 rounded-2xl shadow-xl transition-transform active:scale-95">
                    SORTEAR NÚMEROS
                </button>
                <button id="btn-repeat" class="bg-yellow-500 hover:bg-yellow-600 text-white text-2xl font-bold py-3 rounded-2xl shadow transition-transform active:scale-95 mt-2" disabled>
                    Repetir Som
                </button>
            </div>

            <!-- Opção de Voz (Local vs IA) -->
            <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200 flex flex-col items-center">
                <span class="text-lg font-bold mb-3 text-gray-700">Configuração de Voz</span>
                <div class="flex items-center gap-4">
                    <span class="font-medium text-gray-500">Local (WAV)</span>
                </div>
                <p class="text-xs text-gray-400 mt-4 text-center">
                    O padrão são os seus arquivos na pasta /audio.
                </p>
                <div class="mt-4 w-full flex flex-col items-center">
                    <label class="text-sm text-gray-500 mb-2">Selecionar voz gravada</label>
                    <div class="flex gap-2 w-full">
                        <select id="voice-select" class="flex-1 rounded-md border px-3 py-2">
                            <option value="Danielle">Danielle</option>
                        </select>
                    </div>
                    <div class="text-xs text-gray-400 mt-2">Pasta atual: <span id="voice-current">Danielle</span></div>
                </div>
            </div>
        </div>

        <!-- HISTÓRICO -->
        <div class="w-full mt-10 mb-20">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-700 border-b-2 border-red-200 pb-2">Números Sorteados:</h2>
                <label class="flex items-center gap-2 text-sm text-gray-600">
                    <input id="sort-numeric" type="checkbox" class="form-checkbox h-4 w-4"> Ordenar numericamente
                </label>
            </div>
            <div id="history-list" class="flex flex-wrap gap-3">
                <!-- Injetado via JS -->
            </div>
            <div class="mt-6">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-2xl font-bold text-gray-700 border-b-2 border-red-200 pb-2">Números Remanescentes:</h2>
                    <label class="flex items-center gap-2 text-sm text-gray-600">
                        <input id="toggle-remaining" type="checkbox" class="form-checkbox h-4 w-4">
                        Mostrar
                    </label>
                </div>
                <div id="remaining-list" class="flex flex-wrap gap-2"></div>
                <div class="mt-4 flex justify-center">
                    <button id="btn-reset" class="bg-gray-400 hover:bg-gray-500 text-white text-xl py-3 px-6 rounded-xl transition-all">Reiniciar</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- CONFIGURAÇÃO ---
        const apiKey = ""; // Chave do Gemini (vazia por padrão)
        const letters = ['B', 'I', 'N', 'G', 'O'];
        let pool = [];
        let drawn = [];

        // Elementos DOM
        const lblLetter = document.getElementById('label-letter');
        const lblNumber = document.getElementById('label-number');
        const btnDraw = document.getElementById('btn-draw');
        const btnReset = document.getElementById('btn-reset');
        const btnRepeat = document.getElementById('btn-repeat');
        const historyList = document.getElementById('history-list');
        const voiceSelect = document.getElementById('voice-select');
        const voiceCurrent = document.getElementById('voice-current');
        const sortNumeric = document.getElementById('sort-numeric');
        const remainingList = document.getElementById('remaining-list');
        const toggleRemaining = document.getElementById('toggle-remaining');

        // Pasta de voz selecionada (padrão = Danielle)
        let voiceFolder = 'Danielle';
        let lastAudioId = null;
        let currentAudio = null;
        let isPlaying = false;

        function initPool() {
            pool = [];
            for (let i = 1; i <= 75; i++) {
                const letter = letters[Math.floor((i - 1) / 15)];
                pool.push({ l: letter, n: i, id: `${letter}${i}` });
            }
        }

        // --- SISTEMA DE ÁUDIO ---

        // 1. Áudio Local (Seus WAVs)
        function playLocalAudio(id) {
            // Não inicia novo áudio enquanto outro estiver tocando
            if (isPlaying) return;

            const folderPath = voiceFolder ? `audio/${voiceFolder}/` : 'audio/';
            const path = `${folderPath}${id}.wav`;
            const audio = new Audio(path);
            currentAudio = audio;
            isPlaying = true;
            // trava botões enquanto toca
            if (btnDraw) btnDraw.disabled = true;
            if (btnRepeat) btnRepeat.disabled = true;

            audio.preload = 'auto';
            audio.play().then(() => {
                // registra o último áudio reproduzido (repetir será habilitado ao finalizar)
                lastAudioId = id;
            }).catch(err => {
                console.warn(`Falha ao reproduzir ${path}:`, err);
                // se falhar em iniciar, libera controles
                isPlaying = false;
                currentAudio = null;
                if (btnDraw) btnDraw.disabled = false;
                if (btnRepeat) btnRepeat.disabled = !lastAudioId;
            });

            audio.addEventListener('ended', () => {
                isPlaying = false;
                currentAudio = null;
                if (btnDraw) btnDraw.disabled = false;
                if (btnRepeat) btnRepeat.disabled = !lastAudioId;
            });

            audio.addEventListener('error', () => {
                // em caso de erro durante a reprodução, garante que liberamos o travamento
                isPlaying = false;
                currentAudio = null;
                if (btnDraw) btnDraw.disabled = false;
                if (btnRepeat) btnRepeat.disabled = !lastAudioId;
            });
        }

        // 2. Áudio Gemini IA (Opcional)
        async function playAiAudio(letter, number) {
            if (!apiKey) {
                console.error("API Key do Gemini não configurada.");
                playLocalAudio(`${letter}${number}`);
                return;
            }

            const prompt = `Diga de forma alegre e carinhosa para uma família reunida: Letra ${letter}, número ${number}!`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: { voiceName: "Aoede" } // Voz calorosa
                                }
                            }
                        }
                    })
                });

                const data = await response.json();
                const base64 = data.candidates[0].content.parts[0].inlineData.data;
                decodeAndPlay(base64);
            } catch (err) {
                console.error("Erro na IA, voltando para local:", err);
                playLocalAudio(`${letter}${number}`);
            }
        }

        // Auxiliar para tocar PCM do Gemini
        function decodeAndPlay(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            
            // Header WAV básico (24kHz Mono)
            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);
            const writeStr = (off, s) => { for (let i = 0; i < s.length; i++) view.setUint8(off + i, s.charCodeAt(i)); };
            writeStr(0, 'RIFF'); view.setUint32(4, 36 + bytes.length, true);
            writeStr(8, 'WAVE'); writeStr(12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true);
            view.setUint32(24, 24000, true); view.setUint32(28, 48000, true);
            view.setUint16(32, 2, true); view.setUint16(34, 16, true);
            writeStr(36, 'data'); view.setUint32(40, bytes.length, true);

            const blob = new Blob([wavHeader, bytes], { type: 'audio/wav' });
            new Audio(URL.createObjectURL(blob)).play();
        }

        // --- LÓGICA DO JOGO ---

        function draw() {
            if (isPlaying) return; // evita sortear enquanto áudio anterior toca

            if (pool.length === 0) {
                lblLetter.textContent = "FIM DE";
                lblNumber.textContent = "JOGO!";
                btnDraw.disabled = true;
                return;
            }

            const idx = Math.floor(Math.random() * pool.length);
            const picked = pool.splice(idx, 1)[0];
            drawn.push(picked);

            // Atualiza UI
            lblLetter.textContent = picked.l;
            lblNumber.textContent = picked.n;

            // Usa áudio local (Gemini não está selecionável)
            playLocalAudio(picked.id);

            updateHistory();
            updateRemaining();
        }

        function updateHistory() {
            const items = drawn.slice();
            let listOrder = [];
            if (sortNumeric && sortNumeric.checked) {
                items.sort((a, b) => a.n - b.n);
                listOrder = items;
            } else {
                listOrder = items.slice().reverse();
            }

            historyList.innerHTML = listOrder.map(item => `
                <div class="history-item bg-white border-2 border-red-200 px-4 py-2 rounded-xl shadow-sm text-lg font-bold text-gray-700">
                    <span class="text-red-600">${item.l}</span>${item.n}
                </div>
            `).join('');
        }

        function updateRemaining() {
            const drawnSet = new Set(drawn.map(d => d.n));
            const remaining = [];
            for (let i = 1; i <= 75; i++) {
                if (!drawnSet.has(i)) remaining.push(i);
            }

            // Render com prefixo de letra (ex: B1, I27)
            remainingList.innerHTML = remaining.map(n => {
                const letter = letters[Math.floor((n - 1) / 15)];
                return `
                <div class="px-3 py-2 rounded-xl bg-red-50 text-red-700 font-bold border border-red-200">${letter}${n}</div>
            `;
            }).join('');
        }

        btnDraw.addEventListener('click', draw);
        if (btnRepeat) {
            // botão de repetir som: toca o último áudio conhecido
            btnRepeat.addEventListener('click', () => {
                if (isPlaying) return; // bloqueia enquanto reproduz
                if (lastAudioId) {
                    playLocalAudio(lastAudioId);
                } else {
                    alert('Nenhum áudio disponível para repetir.');
                }
            });
            // desabilita por padrão até que um áudio seja tocado
            btnRepeat.disabled = true;
        }
        btnReset.addEventListener('click', () => {
            if(confirm("Deseja reiniciar o Bingo da Família Vilaça?")) {
                initPool();
                drawn = [];
                lblLetter.textContent = "PRONTOS?";
                lblNumber.textContent = "VAMOS MAIS UMA!";
                historyList.innerHTML = "";
                // para segurança, interrompe qualquer áudio em reprodução
                if (currentAudio) {
                    try { currentAudio.pause(); currentAudio.currentTime = 0; } catch (e) {}
                    currentAudio = null;
                }
                isPlaying = false;
                btnDraw.disabled = false;
                if (btnRepeat) {
                    btnRepeat.disabled = true;
                }
                lastAudioId = null;
                updateHistory();
                updateRemaining();
            }
        });

        // --- Seletor de voz gravada ---
        function setVoiceFolder(folder) {
            voiceFolder = folder || 'Danielle';
            voiceCurrent.textContent = voiceFolder;
        }

        voiceSelect.addEventListener('change', () => setVoiceFolder(voiceSelect.value));

        // Inicializa com Danielle por padrão
        setVoiceFolder('Danielle');

        // Atualiza histórico imediatamente ao mudar o checkbox de ordenação
        if (sortNumeric) {
            sortNumeric.addEventListener('change', () => updateHistory());
        }

        // Toggle para mostrar/ocultar apenas a lista de remanescentes
        if (toggleRemaining && remainingList) {
            toggleRemaining.addEventListener('change', () => {
                remainingList.style.display = toggleRemaining.checked ? '' : 'none';
            });
            // estado inicial: toggle padrão OFF -> esconder lista
            remainingList.style.display = toggleRemaining.checked ? '' : 'none';
        }

        initPool();
        // Inicializa histórico e remanescentes
        updateHistory();
        updateRemaining();
    </script>
</body>
</html>