<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo da Fam√≠lia Vila√ßa - Jogo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
</head>
<body class="text-gray-800 min-h-screen flex flex-col items-center">

    <!-- Theme Toggle Button -->
    <button id="theme-toggle">üåô Dark</button>

    <!-- Bot√£o Voltar ao Lobby -->
    <button id="btn-back">‚Üê Voltar</button>

    <!-- CABE√áALHO E FOTO DA FAM√çLIA -->
    <header class="w-full max-w-5xl px-6 pt-10 pb-6 text-center">
        <h1 class="text-5xl md:text-6xl font-black drop-shadow-sm mb-4">
            Bingo da FV
        </h1>   
    </header>

    <!-- √ÅREA PRINCIPAL -->
    <main class="w-full max-w-4xl px-4 flex flex-col items-center">
        
        <!-- Painel de Exibi√ß√£o -->
        <div id="display-panel" class="main-card display-card w-full rounded-[3rem] p-10 flex flex-col items-center justify-center relative">
            <div id="current-call" class="text-center">
                <span id="label-letter" class="text-4xl md:text-6xl font-bold block leading-none">AGUARDANDO</span>
                <span id="label-number" class="text-[4rem] md:text-[6rem] font-black leading-none number-display">SORTEIO!</span>
            </div>

            <!-- (Removido overlay de loading da IA) -->
        </div>

        <!-- CONFIGURA√á√ïES E CONTROLES -->
        <div class="w-full mt-8 flex flex-col items-center gap-6">
            
            <!-- Bot√µes Principais -->
            <div class="flex flex-col gap-4 max-w-md w-full">
                <button id="btn-draw" class="text-4xl font-bold py-6 rounded-2xl transition-transform active:scale-95 shadow-sm">
                    SORTEAR N√öMEROS
                </button>
                <button id="btn-repeat" class="text-2xl font-bold py-3 rounded-2xl transition-transform active:scale-95 mt-2 shadow-sm" disabled>
                    REPETIR SOM
                </button>
            </div>
        </div>

        <!-- HIST√ìRICO -->
        <div class="w-full mt-10 mb-20">
            <div class="flex items-center justify-between mb-4">
                <h2 id="drawn-title" class="text-2xl font-bold text-accent border-b-2 pb-2">N√∫meros Sorteados:</h2>
                <label class="flex items-center gap-2 text-sm standalone-text">
                    <input id="sort-numeric" type="checkbox" class="form-checkbox h-4 w-4"> Ordenar numericamente
                </label>
            </div>
            <div id="history-list" class="flex flex-wrap gap-3">
                <!-- Injetado via JS -->
            </div>
            <div class="mt-6">
                <div class="flex items-center justify-between mb-2">
                    <h2 id="remaining-title" class="text-2xl font-bold text-accent border-b-2 pb-2">N√∫meros Remanescentes:</h2> 
                    <label class="flex items-center gap-2 text-sm standalone-text">
                        <input id="toggle-remaining" type="checkbox" class="form-checkbox h-4 w-4">
                        Mostrar
                    </label>
                </div>
                <div id="remaining-list" class="flex flex-wrap gap-2"></div>
                <div class="mt-4 flex justify-center">
                    <button id="btn-reset" class="bg-gray-400 hover:bg-gray-500 text-white text-xl py-3 px-6 rounded-xl transition-all">TEMOS UM VENCEDOR!</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- CONFIGURA√á√ÉO ---
        const apiKey = ""; // Chave do Gemini (vazia por padr√£o)
        const letters = ['B', 'I', 'N', 'G', 'O'];
        let pool = [];
        let drawn = [];

        // Elementos DOM
        const lblLetter = document.getElementById('label-letter');
        const lblNumber = document.getElementById('label-number');
        const btnDraw = document.getElementById('btn-draw');
        const btnReset = document.getElementById('btn-reset');
        const btnRepeat = document.getElementById('btn-repeat');
        const btnBack = document.getElementById('btn-back');
        const historyList = document.getElementById('history-list');
        const drawnTitle = document.getElementById('drawn-title');
        const remainingTitle = document.getElementById('remaining-title');
        const sortNumeric = document.getElementById('sort-numeric');
        const remainingList = document.getElementById('remaining-list');
        const toggleRemaining = document.getElementById('toggle-remaining');

        // Pasta de voz selecionada (padr√£o = Danielle)
        let voiceFolder = localStorage.getItem('voiceFolder') || 'Danielle';
        let lastAudioId = null;
        let currentAudio = null;
        let isPlaying = false;

        function initPool() {
            pool = [];
            for (let i = 1; i <= 75; i++) {
                const letter = letters[Math.floor((i - 1) / 15)];
                pool.push({ l: letter, n: i, id: `${letter}${i}` });
            }
        }

        // --- SISTEMA DE √ÅUDIO ---

        // 1. √Åudio Local (Seus WAVs)
        function playLocalAudio(id, silvioMode = null) {
            // N√£o inicia novo √°udio enquanto outro estiver tocando
            if (isPlaying) return;
            const folderPath = voiceFolder ? `audio/${voiceFolder}/` : 'audio/';
            const path = `${folderPath}${id}.wav`;
            if (silvioMode) {
                path = `${folderPath}${silvioMode}.wav`;
            }
            const audio = new Audio(path);
            currentAudio = audio;
            isPlaying = true;
            // trava bot√µes enquanto toca
            if (btnDraw) btnDraw.disabled = true;
            if (btnRepeat) btnRepeat.disabled = true;

            audio.preload = 'auto';
            audio.play().then(() => {
                // registra o √∫ltimo √°udio reproduzido (repetir ser√° habilitado ao finalizar)
                lastAudioId = id;
            }).catch(err => {
                console.warn(`Falha ao reproduzir ${path}:`, err);
                // se falhar em iniciar, libera controles
                isPlaying = false;
                currentAudio = null;
                if (btnDraw) btnDraw.disabled = false;
                if (btnRepeat) btnRepeat.disabled = !lastAudioId;
            });

            audio.addEventListener('ended', () => {
                isPlaying = false;
                currentAudio = null;
                if (btnDraw) btnDraw.disabled = false;
                if (btnRepeat) btnRepeat.disabled = !lastAudioId;
            });

            audio.addEventListener('error', () => {
                // em caso de erro durante a reprodu√ß√£o, garante que liberamos o travamento
                isPlaying = false;
                currentAudio = null;
                if (btnDraw) btnDraw.disabled = false;
                if (btnRepeat) btnRepeat.disabled = !lastAudioId;
            });
        }

        // 2. √Åudio Gemini IA (Opcional)
        async function playAiAudio(letter, number) {
            if (!apiKey) {
                console.error("API Key do Gemini n√£o configurada.");
                playLocalAudio(`${letter}${number}`);
                return;
            }

            const prompt = `Diga de forma alegre e carinhosa para uma fam√≠lia reunida: Letra ${letter}, n√∫mero ${number}!`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: { voiceName: "Aoede" } // Voz calorosa
                                }
                            }
                        }
                    })
                });

                const data = await response.json();
                const base64 = data.candidates[0].content.parts[0].inlineData.data;
                decodeAndPlay(base64);
            } catch (err) {
                console.error("Erro na IA, voltando para local:", err);
                playLocalAudio(`${letter}${number}`);
            }
        }

        // Auxiliar para tocar PCM do Gemini
        function decodeAndPlay(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            
            // Header WAV b√°sico (24kHz Mono)
            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);
            const writeStr = (off, s) => { for (let i = 0; i < s.length; i++) view.setUint8(off + i, s.charCodeAt(i)); };
            writeStr(0, 'RIFF'); view.setUint32(4, 36 + bytes.length, true);
            writeStr(8, 'WAVE'); writeStr(12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true);
            view.setUint32(24, 24000, true); view.setUint32(28, 48000, true);
            view.setUint16(32, 2, true); view.setUint16(34, 16, true);
            writeStr(36, 'data'); view.setUint32(40, bytes.length, true);

            const blob = new Blob([wavHeader, bytes], { type: 'audio/wav' });
            new Audio(URL.createObjectURL(blob)).play();
        }

        // --- L√ìGICA DO JOGO ---

        function draw() {
            if (isPlaying) return; // evita sortear enquanto √°udio anterior toca

            if (pool.length === 0) {
                lblLetter.textContent = "FIM DE";
                lblNumber.textContent = "JOGO!";
                btnDraw.disabled = true;
                return;
            }

            const idx = Math.floor(Math.random() * pool.length);
            const picked = pool.splice(idx, 1)[0];
            drawn.push(picked);

            // Atualiza UI
            lblLetter.textContent = picked.l;
            lblNumber.textContent = picked.n;

            // Usa √°udio local (Gemini n√£o est√° selecion√°vel)
            playLocalAudio(picked.id);

            updateHistory();
            updateRemaining();
        }

        function updateHistory() {
            const items = drawn.slice();
            let listOrder = [];
            if (sortNumeric && sortNumeric.checked) {
                items.sort((a, b) => a.n - b.n);
                listOrder = items;
            } else {
                listOrder = items.slice().reverse();
            }

            historyList.innerHTML = listOrder.map(item => `
                <div class="history-item px-4 py-2 rounded-xl shadow-sm text-lg font-bold">
                    <span style="color:#071029; margin-right:.4rem">${item.l}</span>${item.n}
                </div>
            `).join('');
            drawnTitle.textContent = `N√∫meros Sorteados: ${drawn.length}`;
            remainingTitle.textContent = `N√∫meros Remanescentes: ${75 - drawn.length}`;
        }

        function updateRemaining() {
            const drawnSet = new Set(drawn.map(d => d.n));
            const remaining = [];
            for (let i = 1; i <= 75; i++) {
                if (!drawnSet.has(i)) remaining.push(i);
            }

            // Render com prefixo de letra (ex: B1, I27)
            remainingList.innerHTML = remaining.map(n => {
                const letter = letters[Math.floor((n - 1) / 15)];
                return `
                <div class="px-3 py-2 rounded-xl font-bold" style="background:#ffffff; color:#071029; border:1px solid rgba(7,16,41,0.04); box-shadow:0 2px 8px rgba(0,0,0,0.04)">${letter}${n}</div>
            `;
            }).join('');
        }

        btnDraw.addEventListener('click', draw);
        if (btnRepeat) {
            // bot√£o de repetir som: toca o √∫ltimo √°udio conhecido
            btnRepeat.addEventListener('click', () => {
                if (isPlaying) return; // bloqueia enquanto reproduz
                if (lastAudioId) {
                    playLocalAudio(lastAudioId);
                } else {
                    alert('Nenhum √°udio dispon√≠vel para repetir.');
                }
            });
            // desabilita por padr√£o at√© que um √°udio seja tocado
            btnRepeat.disabled = true;
        }
        btnReset.addEventListener('click', () => {
            if(confirm("Temos um novo vencedor no Bingo da Fam√≠lia Vila√ßa? (Reiniciar partida)")) {
                playLocalAudio(silvioMode = `parabens`);
                    let params = {
                    particleCount: 500, // Quantidade de confetes
                    spread: 90, // O quanto eles se espalham
                    startVelocity: 70, // Velocidade inicial
                    origin: { x: 0, y: 0.5 }, // Posi√ß√£o inicial na tela
                    angle: 45 // √Çngulo em que os confetes ser√£o lan√ßados
                };

                // Joga confetes da esquerda pra direita
                confetti(params);
                initPool();
                drawn = [];
                lblLetter.textContent = "PRONTOS?";
                lblNumber.textContent = "VAMOS MAIS UMA!";
                historyList.innerHTML = "";
                // para seguran√ßa, interrompe qualquer √°udio em reprodu√ß√£o
                //if (currentAudio) {
                //    try { currentAudio.pause(); currentAudio.currentTime = 0; } catch (e) {}
                //    currentAudio = null;
                //}
                //isPlaying = false;
                btnDraw.disabled = false;
                if (btnRepeat) {
                    btnRepeat.disabled = true;
                }
                lastAudioId = null;
                updateHistory();
                updateRemaining();
            }
        });

        // --- Bot√£o Voltar ao Lobby ---
        btnBack.addEventListener('click', () => {
            if (drawn.length > 0 && confirm("Voc√™ tem um jogo em progresso. Deseja voltar ao lobby?")) {
                window.location.href = 'lobby.html';
            } else if (drawn.length === 0) {
                window.location.href = 'lobby.html';
            }
        });

        // --- Seletor de voz gravada ---
        function setVoiceFolder(folder) {
            voiceFolder = folder || 'Danielle';
            localStorage.setItem('voiceFolder', voiceFolder);
        }

        // Inicializa com configura√ß√£o do localStorage
        setVoiceFolder(voiceFolder);

        // Atualiza hist√≥rico imediatamente ao mudar o checkbox de ordena√ß√£o
        if (sortNumeric) {
            sortNumeric.addEventListener('change', () => updateHistory());
        }

        // Toggle para mostrar/ocultar apenas a lista de remanescentes
        if (toggleRemaining && remainingList) {
            toggleRemaining.addEventListener('change', () => {
                remainingList.style.display = toggleRemaining.checked ? '' : 'none';
            });
            // estado inicial: toggle padr√£o OFF -> esconder lista
            remainingList.style.display = toggleRemaining.checked ? '' : 'none';
        }

        initPool();
        // Inicializa hist√≥rico e remanescentes
        updateHistory();
        updateRemaining();

        // --- Theme Toggle ---
        const themeToggle = document.getElementById('theme-toggle');
        const savedTheme = localStorage.getItem('theme') || 'light';
        
        if (savedTheme === 'light') {
            document.body.classList.add('light-theme');
            themeToggle.textContent = '‚òÄÔ∏è Light';
        } else {
            themeToggle.textContent = 'üåô Dark';
        }

        themeToggle.addEventListener('click', () => {
            const isLight = document.body.classList.toggle('light-theme');
            const newTheme = isLight ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            themeToggle.textContent = isLight ? '‚òÄÔ∏è Light' : 'üåô Dark';
        });
    </script>
</body>
</html>
